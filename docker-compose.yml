###############################################################################
#
# FOR DOCKER-COMPOSE SETTINGS COMMON TO BOTH DEVELOPMENT AND PRODUCTION
#
# Do not edit this file for development changes only, instead use docker-compose.overide.yml
#
# https://docs.docker.com/compose/extends/
################################################################################

services:

  web:
    build:
      context: .
      dockerfile: Dockerfile
      # Enable below when uwsgi-nginx uses unix sock
      # args:
      #   WUID: $WUID
      #   WGID: $WGID
    env_file: .env
    # command: # see docker-compose.overide.yml or docker-compose.prod.yml
    volumes:
      - .:/app
    ports:
      - 8000:8000
    networks:
      - backend-network
      - frontend-network

  celery:
    build:
      context: .
      dockerfile: Dockerfile
    env_file: .env
    command: bash -c "cd src &&
                      celery -A hackerspace_online worker -l info -c 3 -Q default"
    volumes:
      - .:/app
    networks:
      - backend-network

  celery-beat:
    build:
      context: .
      dockerfile: Dockerfile
    env_file: .env
    command: bash -c "cd src &&
                      celery -A hackerspace_online beat -l info --scheduler django_celery_beat.schedulers:DatabaseScheduler"
    volumes:
      - .:/app
    networks:
      - backend-network

  # Redis not workng via AWS Elasticache for some reason so use dockerized Redis for now in production.
  # also saves moeny as Elasticache is not free and can't turn off for staging.
  redis:
      image: "redis:5.0-alpine"
      env_file: .env
      sysctls:
        # Resolve -> # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.
        net.core.somaxconn: 512
      networks:
        - backend-network
      healthcheck:
        test: ["CMD", "redis-cli", "ping"]
        interval: 1s
        timeout: 3s
        retries: 30
      ports:
        - 6379:6379

networks:
  frontend-network:
  backend-network:
